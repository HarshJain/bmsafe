// *********************************************************
// This file contains temperature related functions and data
// *********************************************************

#include "temp.h"

// Correspondance des entrées ADC avec les températures de chaque cellule
uint8	gTempIndex[12] = {
0,	// AN00 : T0 (Temperature 0 for first cell)
2,	// AN01 : T2
4,	// AN02 : T4
6,	// AN03 : T6
8,	// AN04 : T8
9,	// AN05 : T9
10,	// AN06 : T10
11, // AN07 : T11
1,	// AN08 : T1
3,	// AN09 : T3
5,	// AN10 : T5
7	// AN11 : T7
};


// Values of read ADC Voltage and associated Temperature (1°C/ 10)

// Le calcul de la température est le suivant:
//
// T = B / ln(R/A)
// où A = 0,0986 et B = 3435 et R est la résistance du thermistor
// 
// R = 3000 * V / (5-V)
// où V est la tension mesurée par l'ADC
//
// V = 5*ADC / 1024
// où ADC est la mesure de la tension sur 10 bits
//


// 

// Since we do not have access to mathematical functions, we use a pre-calculated table for voltage to temperature conversion
// convertTempTable : contains the values of temperature corresponding to the ADC value (which is a ratio)
// The table needs to be declared this way, otherwise, there is compilation errors
const int16 convertTempTable[361][2]={
{972,-400},
{971,-395},
{970,-390},
{968,-385},
{967,-380},
{965,-375},
{964,-370},
{962,-365},
{961,-360},
{959,-355},
{958,-350},
{956,-345},
{954,-340},
{953,-335},
{951,-330},
{949,-325},
{947,-320},
{945,-315},
{943,-310},
{942,-305},
{940,-300},
{938,-295},
{936,-290},
{933,-285},
{931,-280},
{929,-275},
{927,-270},
{925,-265},
{923,-260},
{920,-255},
{918,-250},
{915,-245},
{913,-240},
{911,-235},
{908,-230},
{906,-225},
{903,-220},
{900,-215},
{898,-210},
{895,-205},
{892,-200},
{889,-195},
{887,-190},
{884,-185},
{881,-180},
{878,-175},
{875,-170},
{872,-165},
{869,-160},
{866,-155},
{862,-150},
{859,-145},
{856,-140},
{853,-135},
{849,-130},
{846,-125},
{843,-120},
{839,-115},
{836,-110},
{832,-105},
{829,-100},
{825,-95},
{821,-90},
{818,-85},
{814,-80},
{810,-75},
{806,-70},
{802,-65},
{799,-60},
{795,-55},
{791,-50},
{787,-45},
{783,-40},
{779,-35},
{774,-30},
{770,-25},
{766,-20},
{762,-15},
{758,-10},
{753,-5},
{749,0},
{745,5},
{740,10},
{736,15},
{732,20},
{727,25},
{723,30},
{718,35},
{714,40},
{709,45},
{705,50},
{700,55},
{695,60},
{691,65},
{686,70},
{681,75},
{677,80},
{672,85},
{667,90},
{662,95},
{658,100},
{653,105},
{648,110},
{643,115},
{638,120},
{634,125},
{629,130},
{624,135},
{619,140},
{614,145},
{609,150},
{604,155},
{600,160},
{595,165},
{590,170},
{585,175},
{580,180},
{575,185},
{570,190},
{565,195},
{561,200},
{556,205},
{551,210},
{546,215},
{541,220},
{536,225},
{531,230},
{527,235},
{522,240},
{517,245},
{512,250},
{507,255},
{503,260},
{498,265},
{493,270},
{488,275},
{484,280},
{479,285},
{474,290},
{470,295},
{465,300},
{460,305},
{456,310},
{451,315},
{447,320},
{442,325},
{438,330},
{433,335},
{429,340},
{424,345},
{420,350},
{415,355},
{411,360},
{407,365},
{402,370},
{398,375},
{394,380},
{390,385},
{386,390},
{381,395},
{377,400},
{373,405},
{369,410},
{365,415},
{361,420},
{357,425},
{353,430},
{349,435},
{345,440},
{341,445},
{338,450},
{334,455},
{330,460},
{326,465},
{323,470},
{319,475},
{315,480},
{312,485},
{308,490},
{304,495},
{301,500},
{297,505},
{294,510},
{291,515},
{287,520},
{284,525},
{281,530},
{277,535},
{274,540},
{271,545},
{268,550},
{265,555},
{261,560},
{258,565},
{255,570},
{252,575},
{249,580},
{246,585},
{243,590},
{240,595},
{238,600},
{235,605},
{232,610},
{229,615},
{226,620},
{224,625},
{221,630},
{218,635},
{216,640},
{213,645},
{211,650},
{208,655},
{206,660},
{203,665},
{201,670},
{198,675},
{196,680},
{193,685},
{191,690},
{189,695},
{186,700},
{184,705},
{182,710},
{180,715},
{178,720},
{175,725},
{173,730},
{171,735},
{169,740},
{167,745},
{165,750},
{163,755},
{161,760},
{159,765},
{157,770},
{155,775},
{154,780},
{152,785},
{150,790},
{148,795},
{146,800},
{144,805},
{143,810},
{141,815},
{139,820},
{138,825},
{136,830},
{134,835},
{133,840},
{131,845},
{130,850},
{128,855},
{127,860},
{125,865},
{124,870},
{122,875},
{121,880},
{119,885},
{118,890},
{116,895},
{115,900},
{114,905},
{112,910},
{111,915},
{110,920},
{108,925},
{107,930},
{106,935},
{105,940},
{103,945},
{102,950},
{101,955},
{100,960},
{99,965},
{97,970},
{96,975},
{95,980},
{94,985},
{93,990},
{92,995},
{91,1000},
{90,1005},
{89,1010},
{88,1015},
{87,1020},
{86,1025},
{85,1030},
{84,1035},
{83,1040},
{82,1045},
{81,1050},
{80,1055},
{79,1060},
{78,1065},
{77,1070},
{76,1075},
{76,1080},
{75,1085},
{74,1090},
{73,1095},
{72,1100},
{71,1105},
{71,1110},
{70,1115},
{69,1120},
{68,1125},
{68,1130},
{67,1135},
{66,1140},
{65,1145},
{65,1150},
{64,1155},
{63,1160},
{63,1165},
{62,1170},
{61,1175},
{61,1180},
{60,1185},
{59,1190},
{59,1195},
{58,1200},
{57,1205},
{57,1210},
{56,1215},
{56,1220},
{55,1225},
{54,1230},
{54,1235},
{53,1240},
{53,1245},
{52,1250},
{52,1255},
{51,1260},
{50,1265},
{50,1270},
{49,1275},
{49,1280},
{48,1285},
{48,1290},
{47,1295},
{47,1300},
{46,1305},
{46,1310},
{46,1315},
{45,1320},
{45,1325},
{44,1330},
{44,1335},
{43,1340},
{43,1345},
{42,1350},
{42,1355},
{42,1360},
{41,1365},
{41,1370},
{40,1375},
{40,1380},
{40,1385},
{39,1390},
{39,1395},
{38,1400}};

//***************************************************************
// Converts the ADC value read to a corresponding temperature
//***************************************************************
int16 convertTemp(uint16 rawTemp) {
  uint16 i = 0;
  
  if(rawTemp < convertTempTable[360][0]) 		// If temperature is higher than 140°C
    return convertTempTable[360][1];	// Define as 140 °C
  else if(rawTemp > convertTempTable[0][0])	// If temperature is lower than -40°C
	return convertTempTable[0][1];		// Define as -40 °C

  // Otherwise, we browse the table to find the corresponding temperature
  for(i = 0; i < 360; i++)
  {
	if(convertTempTable[i][0] < rawTemp)
		break;
  }
  
  // We return the closer corresponding value
  if(convertTempTable[i-1][0] - rawTemp <= rawTemp - convertTempTable[i][0])  
    return convertTempTable[i-1][1];
  else
	return convertTempTable[i][1];
}
